<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KittingFlow (Netlify Frontend)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root{ --gap:12px }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif; margin:16px; color:#222 }
    h1{ margin:0 0 12px }
    .row{ display:flex; gap:var(--gap); margin:var(--gap) 0; flex-wrap:wrap }
    input,button,select{ font-size:16px; padding:10px }
    input,select{ flex:1 1 220px }
    button{ border:1px solid #ccc; background:#fff; border-radius:10px }
    .card{ border:1px solid #ddd; border-radius:12px; padding:14px; margin-top:16px }
    img{ max-width:220px; max-height:220px; object-fit:contain; border:1px solid #eee }
    .muted{ color:#666; font-size:12px }
  </style>
</head>
<body>
  <h1>KittingFlow</h1>
  <div class="row">
    <select id="pidSel" disabled>
      <option>隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</option>
    </select>
    <button id="reload">蜀崎ｪｭ霎ｼ</button>
  </div>
  <div class="row">
    <button id="start">髢句ｧ・/button>
    <button id="snapshot">迴ｾ蝨ｨ縺ｮ迥ｶ諷・/button>
  </div>

  <div class="card" id="view" style="display:none">
    <div><b>陬ｽ蜩！D:</b> <span id="v-id"></span></div>
    <div><b>陬ｽ蜩∝錐:</b> <span id="v-name"></span></div>
    <div style="margin-top:6px"><b>驛ｨ蜩・</b> <span id="v-part"></span></div>
    <div style="margin-top:6px"><img id="v-img" alt="" /></div>
    <div class="row">
      <button id="next">谺｡縺ｸ 笆ｶ</button>
      <button id="pause">竢ｸ 荳ｭ譁ｭ</button>
    </div>
  </div>

  <p class="muted">繝舌ャ繧ｯ繧ｨ繝ｳ繝・ Netlify Functions 竊・GAS /exec</p>

  <script>
    const api = async (payload)=>{
      const res = await fetch('/.netlify/functions/api', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({ok:false,error:'invalid json'}));
      if(!res.ok || !data.ok){ throw new Error(data.error || 'request failed'); }
      if(data._debug&&data._debug.log){ console.debug('[GAS LOG]\n'+data._debug.log); } return data;
    };
    function getId(){
      const sel = document.getElementById('pidSel');
      return sel && sel.value ? sel.value.trim() : '';
    }
    function qs(id){ return document.getElementById(id); }
    function setView(d){
      qs('view').style.display = 'block';
      qs('v-id').textContent = d.id || '';
      qs('v-name').textContent = d.name || '';
      const partLine = (d.partId||'') + (d.partName?(' / '+d.partName):'') + (d.qty?(' / 蠢・ｦ∵焚 '+d.qty):'');
      qs('v-part').textContent = partLine || '-';
      const img = qs('v-img');
      if(d.img){ img.src = d.img; img.style.display = 'block'; } else { img.removeAttribute('src'); img.style.display='none'; }
    }
    async function doStart(){
      const id = getId(); if(!id){ alert('陬ｽ蜩！D繧帝∈謚槭＠縺ｦ縺上□縺輔＞'); return; }
      try{ const {data} = await api({action:'start', id}); setView(data); }
      catch(e){ alert('繧ｨ繝ｩ繝ｼ: '+e.message); }
    }
    async function doSnapshot(){
      const id = getId(); if(!id){ alert('陬ｽ蜩！D繧帝∈謚槭＠縺ｦ縺上□縺輔＞'); return; }
      try{ const {data} = await api({action:'snapshot', id}); setView(data); }
      catch(e){ alert('繧ｨ繝ｩ繝ｼ: '+e.message); }
    }
    async function doNext(){
      const id = getId(); if(!id){ alert('陬ｽ蜩！D繧帝∈謚槭＠縺ｦ縺上□縺輔＞'); return; }
      try{ const {data} = await api({action:'next', id}); setView(data); }
      catch(e){ alert('繧ｨ繝ｩ繝ｼ: '+e.message); }
    }
    async function doPause(){
      const id = getId(); if(!id){ alert('陬ｽ蜩！D繧帝∈謚槭＠縺ｦ縺上□縺輔＞'); return; }
      try{ await api({action:'pause', id}); alert('荳ｭ譁ｭ縺励∪縺励◆'); }
      catch(e){ alert('繧ｨ繝ｩ繝ｼ: '+e.message); }
    }
    async function loadList(){
      try{
        const {data} = await api({action:'list'});
        const sel = qs('pidSel');
        sel.innerHTML = '';
        if(!Array.isArray(data) || data.length===0){
          const op = document.createElement('option'); op.textContent='陬ｽ蜩√′縺ゅｊ縺ｾ縺帙ｓ'; op.value=''; sel.appendChild(op); sel.disabled=true; return;
        }
        data.forEach((x)=>{
          const op = document.createElement('option');
          op.value = x.id; op.textContent = x.id + (x.name? (' / '+x.name):''); sel.appendChild(op);
        });
        sel.disabled = false;
      }catch(e){
        alert('繧ｨ繝ｩ繝ｼ: '+e.message);
      }
    }
    qs('start').onclick = doStart;
    qs('snapshot').onclick = doSnapshot;
    qs('next').onclick = doNext;
    qs('pause').onclick = doPause;
    qs('reload').onclick = loadList;
    // id繧ｯ繧ｨ繝ｪ縺後≠繧後・閾ｪ蜍戊｡ｨ遉ｺ
    const m = location.search.match(/id=([^&]+)/);
    if(m){
      // 繧ｯ繧ｨ繝ｪ蜆ｪ蜈・ 繧ｻ繝ｬ繧ｯ繝医↓蟄伜惠縺吶ｌ縺ｰ驕ｸ謚槭＠縺ｦ陦ｨ遉ｺ縲√↑縺代ｌ縺ｰ繝ｪ繧ｹ繝亥ｾ後↓陦ｨ遉ｺ
      const desired = decodeURIComponent(m[1]);
      loadList().then(()=>{
        const sel = qs('pidSel');
        const opt = Array.from(sel.options).find(o=>o.value===desired);
        if(opt){ sel.value = desired; doSnapshot(); }
      });
    }else{
      loadList();
    }
  </script>
</body>
</html>

