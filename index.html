<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KittingFlow (Netlify Frontend)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root{ --gap:12px }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif; margin:16px; color:#222 }
    h1{ margin:0 0 12px }
    .row{ display:flex; gap:var(--gap); margin:var(--gap) 0; flex-wrap:wrap }
    input,button,select{ font-size:16px; padding:10px }
    input,select{ flex:1 1 220px }
    button{ border:1px solid #ccc; background:#fff; border-radius:10px }
    .card{ border:1px solid #ddd; border-radius:12px; padding:14px; margin-top:16px }
    img{ max-width:220px; max-height:220px; object-fit:contain; border:1px solid #eee }
    .muted{ color:#666; font-size:12px }
    pre{ white-space:pre-wrap; word-break:break-word; font-family:Menlo,Consolas,"Courier New",monospace; font-size:12px; margin:8px 0 0 }
  </style>
</head>
<body>
  <h1>KittingFlow</h1>
  <div class="row">
    <select id="pidSel" disabled>
      <option>読み込み中...</option>
    </select>
    <button id="reload">再読込</button>
    <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
      <input type="checkbox" id="debugToggle">
      Debug Log
    </label>
  </div>
  <div class="row">
    <button id="start">開始</button>
    <button id="snapshot">現在の状況</button>
  </div>

  <div class="card" id="view" style="display:none">
    <div><b>製品ID:</b> <span id="v-id"></span></div>
    <div><b>製品名:</b> <span id="v-name"></span></div>
    <div style="margin-top:6px"><b>部品:</b> <span id="v-part"></span></div>
    <div style="margin-top:6px"><img id="v-img" alt="" /></div>
    <div class="row">
      <button id="next">次へ ▶</button>
      <button id="pause">⏸ 中断</button>
    </div>
  </div>

  <p class="muted">バックエンド: Netlify Functions 経由で GAS /exec</p>

  <div class="card muted" id="debugCard">
    <div><b>Debug Log</b></div>
    <pre id="debugLog"></pre>
  </div>

  <script>
    const api = async (payload)=>{
      const body = { ...(payload || {}) };
      if(isDebugEnabled()){ body.debug = true; }
      const res = await fetch('/.netlify/functions/api', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const data = await res.json().catch(()=>({ok:false,error:'invalid json'}));
      if(data._debug && data._debug.log){
        console.debug('[GAS LOG]\n'+data._debug.log);
        setDebugLog(data._debug.log);
      }else{
        setDebugLog('');
      }
      if(!res.ok || !data.ok){ throw new Error(data.error || 'request failed'); }
      return data;
    };
    function getId(){
      const sel = document.getElementById('pidSel');
      return sel && sel.value ? sel.value.trim() : '';
    }
    function qs(id){ return document.getElementById(id); }
    function setView(d){
      qs('view').style.display = 'block';
      qs('v-id').textContent = d.id || '';
      qs('v-name').textContent = d.name || '-';
      const partLine = (d.partId||'') + (d.partName?(' / '+d.partName):'') + (d.qty?(' / 必要数 '+d.qty):'');
      qs('v-part').textContent = partLine || '-';
      const img = qs('v-img');
      if(d.img){ img.src = d.img; img.style.display = 'block'; } else { img.removeAttribute('src'); img.style.display='none'; }
    }
    function setDebugLog(log){
      const card = qs('debugCard');
      const pre = qs('debugLog');
      if(!card || !pre) return;
      if(log){
        pre.textContent = log;
        card.style.display = 'block';
      }else{
        pre.textContent = '';
        card.style.display = 'none';
      }
    }
    function isDebugEnabled(){
      const toggle = qs('debugToggle');
      return !!(toggle && toggle.checked);
    }
    async function doStart(){
      const id = getId(); if(!id){ alert('製品IDを選択してください'); return; }
      try{ const {data} = await api({action:'start', id}); setView(data); }
      catch(e){ alert('エラー: '+e.message); }
    }
    async function doSnapshot(){
      const id = getId(); if(!id){ alert('製品IDを選択してください'); return; }
      try{ const {data} = await api({action:'snapshot', id}); setView(data); }
      catch(e){ alert('エラー: '+e.message); }
    }
    async function doNext(){
      const id = getId(); if(!id){ alert('製品IDを選択してください'); return; }
      try{ const {data} = await api({action:'next', id}); setView(data); }
      catch(e){ alert('エラー: '+e.message); }
    }
    async function doPause(){
      const id = getId(); if(!id){ alert('製品IDを選択してください'); return; }
      try{ await api({action:'pause', id}); alert('中断しました'); }
      catch(e){ alert('エラー: '+e.message); }
    }
    async function loadList(){
      try{
        const {data} = await api({action:'list'});
        const sel = qs('pidSel');
        sel.innerHTML = '';
        if(!Array.isArray(data) || data.length===0){
          const op = document.createElement('option'); op.textContent='製品がありません'; op.value=''; sel.appendChild(op); sel.disabled=true; return;
        }
        data.forEach((x)=>{
          const op = document.createElement('option');
          op.value = x.id; op.textContent = x.id + (x.name? (' / '+x.name):''); sel.appendChild(op);
        });
        sel.disabled = false;
      }catch(e){
        alert('エラー: '+e.message);
      }
    }
    qs('start').onclick = doStart;
    qs('snapshot').onclick = doSnapshot;
    qs('next').onclick = doNext;
    qs('pause').onclick = doPause;
    qs('reload').onclick = loadList;
    // idクエリがあれば自動表示
    const m = location.search.match(/id=([^&]+)/);
    if(m){
      // クエリ優先: セレクトに存在すれば選択して表示、なければリスト後に表示
      const desired = decodeURIComponent(m[1]);
      loadList().then(()=>{
        const sel = qs('pidSel');
        const opt = Array.from(sel.options).find(o=>o.value===desired);
        if(opt){ sel.value = desired; doSnapshot(); }
      });
    }else{
      loadList();
    }
  </script>
</body>
</html>
